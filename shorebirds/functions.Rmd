```{r functions,include=FALSE}
## work in progress: GUI aids to making a spreadsheet of tag metadata
## concord with the structure of the motus DB so we can push data
## rather than force users to enter it all via the web.

library(gWidgets2)
library(readxl)

TS = function(x) structure(x, class=c("POSIXt", "POSIXct"))

gchoose = function(title, message, choices) {
    choice = NULL
    dlg = gbasicdialog(title=title,
                       handler=function(...) {
                           choice <<- gc$get_value()
                       })
    glabel(text=message, container=dlg, spacing=0)
    gc = gradio(items=choices, container=dlg, spacing=0)
    visible(dlg)
    return(choice)
}

askUserForXLSheet = function() {
    ## returns a file path and sheet name selected by the user
    f = gfile(text = "Select a spreadsheet file...",
              type="open",
              filter = list ("Excel files" = list(patterns=c("*.xls", "*.xlsx")),
                                   "All files" = list(patterns=c("*"))))
    if (length(f) == 0)
        return(NULL)
    ss = excel_sheets(f)
    if (length(ss) > 1) {
        s = gchoose("Choose a sheet",
                    sprintf("The file \n\n  %s\n\n has multiple sheets.  Please choose the one you wish to read:", f), ss)
        if (is.null(s))
            return(NULL)
    } else {
        s = ss
    }
    return(list(file=f, sheet=s))
}

gmatch = function(title, lName, lItems, rName, rItems, initMatch=match(lItems,rItems), message = NULL ) {
    # open a dialogue that lets the user
    # match items in two lists
    # returns a matrix whose rows are matches between the first
    # column and the second column

    okay = FALSE
    ww <- gbasicdialog(title, visible=FALSE, 
                       handler = function(...) {
                           okay <<- TRUE
                       })
##                       use.scrollwindow = TRUE)
    
 ##   ww <- gwindow(title, visible=FALSE, width=600, height=600)
    w = ggroup(cont=ww, width=600, height=600)
##                       use.scrollwindow = TRUE)
    g = gvbox(cont=w)
    glabel( if(is.null(message)) {
                "Select an item in one list and double-click on its match in the other list.\nDouble-click on a matched pair to undo it."
                } else {
                    message
                },
           cont=g)
    
    pg = gpanedgroup(cont=g)
    pg2 = gpanedgroup(cont=pg)
    lList = rList = list()
    if (length(initMatch) > 0) {
        il = which(! is.na(initMatch))
        ir = initMatch[il]
        mList = data_frame(l = I(lItems[il]), r = I(rItems[ir]))
    } else {
        mList = data_frame(l = character(), r = character())
    }
    names(mList) = c(lName, rName)
    if (length(il) > 0) {
        lItems = lItems[0 - il]
        rItems = rItems[0 - ir]
    }
    ## create named lists of items, so gtable displays a heading
    lList[[lName]] = lItems
    rList[[rName]] = rItems
    
    ltab = gtable(lList, cont=pg2)
    rtab = gtable(rList, cont=pg2)
    gg = gvbox(cont=pg)
    glabel("Matched Pairs", cont=gg, anchor=c(0, 0))
    mtab = gtable(mList, cont=gg)
    size(ww) <- c(800, 600)

    ## split the nested frames evenly
    svalue(pg) <- 0.5
    svalue(pg2) <- 0.5

    pairSelected = function(...) {
        ## browser()
        ## the user has selected a pair to match
        i = ltab$get_selection()
        j = rtab$get_selection()
        if (length(i) > 0 & length(j) > 0) {
            mList <<- rbind(mList, data.frame(l = I(lList[[1]][i]), r = I(rList[[1]][j])))
            lList[[1]] <<- lList[[1]][-i]
            rList[[1]] <<- rList[[1]][-j]

            ## refresh GUI
            ltab[] <<- lList
            rtab[] <<- rList
            mtab[] <<- mList
        }
    }

    pairDeselected = function(...) {
        ## browser()
        ## the user has selected a matched pair to unmatch
        i = mtab$get_selection()
        if (length(i) > 0) {
            lList[[1]] <<- c(lList[[1]], mList[i, 1])
            rList[[1]] <<- c(rList[[1]], mList[i, 2])
            mList <<- mList[-i, ]

            ## refresh GUI
            ltab[] <<- lList
            rtab[] <<- rList
            mtab[] <<- mList
        }
    }
    addHandlerDoubleclick(ltab, pairSelected)
    addHandlerDoubleclick(rtab, pairSelected)
    addHandlerDoubleclick(mtab, pairDeselected)
    size(ww) <- c(600, 600)
    out <- visible(ww)
    return(if(okay) mList else NULL)
}

## example:
## gmatch("Match project names",
##        "Numerals",
##        as.character(10:1), "Words", c("one", "two", "three", "four", "five", "10", "1"))

```
