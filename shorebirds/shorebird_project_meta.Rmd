---
title: "Work Log(2): Upload of Metadata from Paul Smith's Shorebird Tag Database to motus-wts.org"
author: "John Brzustowski"
date: "December, 2015"
output:
   pdf_document :
       toc: true
       toc_depth: 4
---


```{r setup, include=FALSE, results="hide"}
knitr::opts_chunk$set(comment="")
options(warn=0, digits=14) ## for full printing of timestamps
library(dplyr)
library(lubridate)
library(motus, quietly=TRUE)
```

Read the frame of matched tags.

```{r}
motusLoadSecrets("~/.secrets/motusSecrets.json")
RESULTS_FILE = "shorebird_results_1.rds"
x = readRDS(RESULTS_FILE)$found
```

```{r child="functions.Rmd", echo=FALSE, include=FALSE, cache=TRUE}
```

# Summary

Now that we've reconciled registrations of (almost) all tags from the
spreadsheet Paul Smith has assembled, we need to push the tag metadata
to motus-wts.org

# Deployment Fields

The fields required for a motus tag deployment record are
(see \ref{appendix2} for details).

--------------------------------------------------------------------------
deployment   description                 how to obtain it from existing
  field                                  columns in reconciled spreadsheet
------------ --------------------------- -------------------------------------
  tagID      unique Motus tag ID         `tagID`
                                         
  status     pending, deploy, or         `"pending"`
             terminate
                                         
 lat         latitude                    `Latitude`
                                         
 lon         longitude                   `Longitude`
                                         
 tsStart     timestamp for start of      see below
             deployment
                                         
speciesID    numeric motus ID for this   `spCodeID[x$SpeciesID]` (and see below)
             species
                                         
markerType   type of marker              `"metal band"`
                                         
markerNumber number on marker            `MetalOut`
                                         
 comments    comments; we use JSON to     see below
             represent the remaining
             fields from the spreadsheet

 ts          timestamp deployment was     `unclass(Sys.time())`
             registered

---------------------------------------------------------------------------------

## Missing Lat/Lon

Two sites are missing Lat / Lon:

US New Jersey Villas, Eldredge.  I'm guessing this is the shore
at the end of Eldredge Ave, in Villas near Cape May:

Lat=39.0445286 Lon=-74.9312826 as seen [here](https://www.google.ca/maps/place/39%C2%B002'40.3%22N+74%C2%B055'52.6%22W/@39.0445286,-74.9334713,17z/data=!3m1!4b1!4m2!3m1!1s0x0:0x0)

The other is Moores, which I'm assuming is Moores Beach in the same
general area:

Lat=39.1887706, Lon=-74.951186 as seen [here](https://www.google.ca/maps/place/39%C2%B011'19.6%22N+74%C2%B057'04.3%22W/@39.1887706,-74.9533747,17z/data=!3m1!4b1!4m2!3m1!1s0x0:0x0)

Sjoerd also provided (Dec. 21) a correction to the location for Avalon.

We fill these in now:

```{r}

x[x$LocationID=="Villas, Eldredge", "Latitude"] = 39.0445286
x[x$LocationID=="Villas, Eldredge", "Longitude"] = -74.9312826

x[x$LocationID=="Moores", "Latitude"] = 39.1887706
x[x$LocationID=="Moores", "Longitude"] = -74.951186 

x[x$LocationID=="Avalon", "Latitude"] =  39.11402
x[x$LocationID=="Avalon", "Longitude"] = -74.71421

```

## Conversion of date/times to GMT

Users provided tag deployment dates and times in local time.  We need to convert
these to GMT.  This is not trivial, as GMT offsets vary with location and time
of year.  There doesn't appear to be an R package to handle this, but there's
a nodejs library to do so [here](https://github.com/mattbornski/tzwhere). 
We implement the lookup as a function that builds a simple javascript
file and runs it through nodejs:

```{r}
x = x %>%
    mutate (
        Hour = sub(":.*", "", Release.Time),
        Min = sub(".*:", "", Release.Time),
        tsGMT = getGMTFromLocal(Latitude, Longitude, Yr, Month, Day, Hour, Min )
    )
## indexes of bad timestamps (couldn't find timezone for point)
bad = which(x$tsGMT == 0)

## list of unique locations with no timezone
badSite = unique(x$LocationID[bad])
```

This leaves `r sum(bad)` dates uncorrected.  These correspond to these
`r length(badSite)` sites:

```{r}
badSite
```

Sjoerd provided (Dec. 21) timezones for these sites, so we use those to
convert release times to GMT.
```{r}
## read timezones, removing blank spaces so ymd_hms() will recognize them
sts = readRDS("TZ.rds") %>% as.tbl %>% mutate(TZ=gsub(" ", "", as.character(TZ)))

## lookup corrected timezone by LocationID
fixTZ = (x[bad,] %>% left_join (sts, by="LocationID")) $TZ

## we have to run this in a loop because the ymd_hms function doesn't
## recycle the timezone argument

for (i in seq(along=bad)) {
    b = bad[i]  ## index of i'th bad (i.e. unknown timezone) timestamp
    x$tsGMT[b] = with(x,
                      ymd_hms(paste(Yr[b], Month[b], Day[b],
                                    sub(":.*", "", Release.Time[b]), ## HH
                                    sub(".*:", "", Release.Time[b]), ## MM
                                    0                                ## SS
                                    ),
                              tz = fixTZ[i]
                              )
                      )
}
 
```
## Representing Additional Fields in the Properties Item

We include the following items in a JSON-encoded list which goes
into the `properties` field in the motus tag deployment registration:

 - AgeID
 - bill
 - blood
 - Country
 - Culmen
 - FatScore
 - LocationID
 - Province
 - SexID
 - tarsus
 - Tot_Head
 - Weight
 - Wing

## Species Code

Motus requires numeric species IDs, so we lookup the motus IDs for
each 4-letter species code:

```{r, cached=TRUE}
spCodeID = list()
for(m in unique(x$SpeciesID))
    spCodeID[[m]] = motusListSpecies(m, qlang="CD")$id[1]

```

## Upload Deployment Records

We now have everything we need.

```{r}

RESULTS2_FILE = "shorebird_results_2.rds"
saveRDS(x, RESULTS2_FILE)

## we'll want to remove any property values which are NA
trimList = function(...) {
    l = list(...)
    l[! sapply(l, function(x) is.null(x) || is.na(x))]
}

#for (i in 1:nrow(x)) {
for (i in 1:1) {
    with(x[i, ],
         motusDeployTag(
             tagID        = tagID,
             status       = "pending",
             lat          = Latitude,
             lon          = Longitude,
             tsStart      = tsGMT,
             speciesID    = spCodeID[[SpeciesID]],
             markerType   = "metal band",
             markerNumber = MetalOut,
             comments     = comments,
             properties   = trimList (
                 ageID      = AgeID,
                 bill       = bill,
                 blood      = blood,
                 country    = Country,
                 culmen     = Culmen,
                 fatScore   = FatScore,
                 locationID = LocationID,
                 province   = Province,
                 sexID      = SexID,
                 tarsus     = tarsus,
                 totHead    = Tot_Head,
                 weight     = Weight,
                 wing       = Wing
             )
         ))
}

```

\newpage

```{r, child=c("appendix2.Rmd")}
```
