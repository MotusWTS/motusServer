<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <!--


        This file generates the status download page at
        https://sgdata.motus.org/status2  It requires authentication via
        apache's mod_auth_tkt.  The authentication cookie is generated by
        the script login.php

        Data fetching uses jquery $.query() calls to the status server
        API.  Data rendering uses the jquery mustache plugin, with white
        mathematical square brackets as tag delimiters.  We've modifed
        mustache.js to allow tagging javascript objects with a logical
        attribute called "__transpose__".  If this is truthy, the object
        is treated as a list of arrays, whose elements are recycled to the
        length of the longest array.  This is an alternative layout to the
        usual array of objects, wherein each object has the same named
        items, and is compatible with the JSON returned by the status API.

        Replies from the status API are normally bz2-compressed
        JSON-encoded objects,but if the request includes an
        `Accept-Encoding` header containing the word 'gzip', they are
        gzip-compressed.  This page uses that feature, because
        browser-side javascript doesn't seem to support bz2-compression.

        API documentation is here:

        https://github.com/jbrzusto/motusServer/blob/new_server/inst/doc/status_api.md

      -->
    <title>Status of Motus Processing Version 2 (using API back-end)</title>
    <script language="javascript" type="text/javascript"
            src="/javascript/jquery/jquery.min.js"></script>
    <script language="javascript" type="text/javascript"
            src="/download/status2.js"></script>
    <script language="javascript" type="text/javascript"
            src="/download/jquery.mustache.min.js"></script>
    <script language="javascript" type="text/javascript"
            src="/download/mustache.min.js"></script>
    <script language="javascript" type="text/javascript"
            src="/download/status2.js"></script>
    <script language="javascript"  type="text/javascript"
            src="/download/jquery-ui-1.12.1/jquery-ui.min.js">script</script>
    <link rel="stylesheet" href="/download/jquery-ui-1.12.1/jquery-ui.min.css">
    <link rel="stylesheet" href="/download/status2.css">
    <script language="javascript" type="text/javascript">
      // once the page and scripts have loaded, launch the business logic to populate it.
      $(initStatus2Page);
    </script>
  </head>
  <body>
    <span class="jobs_heading">Status of your motus data-processing jobs</span>
    <div class="jobs_navigation">
      <span class="navigate" target="top"></span>
      <span class="navigate" target="up"></span>
      <span class="navigate" target="down"></span>
      <span class="navigate" target="bottom"></span>
      <label for="find_job_selector">Listing shows</label>
      <select id="find_job_selector">
        <option value="all" selected>all jobs</option>
        <option value="id">job with ID = </option>
        <option value="idnear">jobs with ID &gt;= </option>
        <option value="motusUserID">jobs for motus user ID = </option>
        <option value="motusProjectID"> jobs for motus project ID = </option>
        <option value="log">jobs with log matching</option>
      </select>
      <input type="text" id="find_job_key" value="">
      <span id="find_job_button"></span>
      <label for="error_only_option">only with errors</label>
      <input type="checkbox" name="error_only_option" id="error_only_option">
    </div>
    <!------- Sections filled in by templates ------->
    <div class="job_list">
    </div>
    <div class="job_details">
    </div>
    <div class="job_error">
    </div>
    <div class="job_no_results">
    </div>
    <div class="querying_server">
    </div>
    <div class="recv_info">
    </div>
    <div class="recv_files">
    </div>
    <div class="job_dump">
    </div>

    <!---------  Template 'scripts' follow -------->

    <script id="tpl_job_list" type="text/html">
      {{! template to render the table of jobs }}
      {{=⟦ ⟧=}}
      <table class="jobs_table">
        <tr class="jobs_table_heading">
          <th><span class="sort_heading" sort_field="id">Job ID</span></th>
          <th><span class="sort_heading" sort_field="motusUserID">User ID</span></th>
          <th><span class="sort_heading" sort_field="motusProjectID">Project ID</span></th>
          <th><span class="sort_heading" sort_field="type">Type</span></th>
          <th><span class="sort_heading" sort_field="ctime">Created</span></th>
          <th><span class="sort_heading" sort_field="mtime">Last Activity</span></th>
          <th>Status</th>
          <th>Parameters</th>
        </tr>
        ⟦#jobs⟧
        <tr class="jobs_table_row" job_id="⟦id⟧" id="jobs_table_row⟦id⟧">
          <td class="job_id">⟦id⟧</td>
          <td class="job_motus_user_id">⟦motusUserID⟧
          <td class="job_motus_project_id">⟦motusProjectID⟧
          <td class="job_type">⟦type⟧</td>
          <td class="timestamp">⟦fmt_ctime⟧</td>
          <td class="timestamp">⟦fmt_mtime⟧</td>
          <td>⟦&fmt_done⟧</td>
          <td class="job_params">⟦&params⟧</td>
        </tr>
        ⟦/jobs⟧
      </table>
    </script>

    <script id="tpl_job_details" type="text/html">
      {{! template to render the details of a job}}
      {{=⟦ ⟧=}}
      <span class="job_product_heading">Products:</span>
      <div id="job_product_list">
        <ul>
          ⟦#products⟧
          <li class="job_product_list_item"><a href="⟦link⟧" target="_blank">⟦name⟧</a></li>
          ⟦/products⟧
          ⟦^products⟧
          (none)
          ⟦/products⟧
        </ul>
      </div>
      <div>
        <span class="summary_heading">Summary:</span>
        <div class="job_summary">
          ⟦! the next item is not indented, to support `preformatted` styling⟧
⟦&summary⟧
        </div>
      </div>
      <span class="subjobs_heading">Sub Jobs:</span>
      <table class="subjobs_table">
        <tr class="subjobs_table_heading">
          <th>Job ID</th>
          <th>Type</th>
          <th>Created</th>
          <th>Status</th>
          <th>Parameters</th>
        </tr>
        ⟦#details⟧
        <tr class="subjob_table_row" job_id="⟦id⟧">
          <td class="job_id">⟦id⟧</td>
          <td class="job_type">⟦type⟧</td>
          <td class="timestamp">⟦fmt_ctime⟧</td>
          <td>⟦&fmt_done⟧</td>
          <td class="job_params">⟦&params⟧</td>
        </tr>
        ⟦/details⟧
      </table>
      <div>
        <span class="log_heading">Log:</span>
        <div class="job_log">
          ⟦! the next item is not indented, to support `preformatted` styling⟧
⟦&log⟧
        </div>
      </div>
    </script>
    <script id="tpl_job_error" type="text/html">
      {{! template to render an error message}}
      {{=⟦ ⟧=}}
      <div>
        <span class="copy_error_message">Copy Error to Clipboard</span>
      </div>
      When trying to fetch job information, this error was received:
      ⟦! the next `div` holds what gets copied to the clipboard⟧
      <div class="job_error_contents">
        <div class="job_error_message">
          ⟦error⟧
        </div>
        The api entry called was:
        <div class="job_error_api">
          ⟦api⟧
        </div>
        with these parameters:
        <div class="job_error_json">
          ⟦! the next item is not indented, to support `preformatted` styling⟧
⟦json⟧
        </div>
        and this browser state:
        <div class="job_error_state">
          ⟦! the next item is not indented, to support `preformatted` styling⟧
⟦state⟧
        </div>
      </div>
    </script>
    <script id="tpl_job_no_results" type="text/html">
      {{! template to render a message indicating no results}}
      {{=⟦ ⟧=}}
      <div class="job_no_results_message">
        There are no (more?) jobs matching the search criteria.
        Hit ESC to close this window.
      </div>
    </script>
    <script id="tpl_querying_server" type="text/html">
      {{! template to render a message indicating a query is active}}
      {{=⟦ ⟧=}}
      <div class="querying_server_message">
        Running this query:
        <div class="querying_server_api">
          ⟦query⟧
        </div>
        with parameters:
        <div class="querying_server_params">
          ⟦params⟧
        </div>
      </div>
    </script>
    <script id="tpl_recv_info" type="text/html">
      {{! template to render information about a receiver}}
      {{=⟦ ⟧=}}
      <div class="recv_info_heading">
        Serno: ⟦serno⟧; deviceID: ⟦deviceID⟧; receiverType: ⟦receiverType⟧
      </div>
      <div class="recv_deps_heading">Deployments:</div>
      <table class="recv_deps_table">
        <tr class="recv_deps_table_heading">
          <th>deployID</th>
          <th>name</th>
          <th>fixtureType</th>
          <th>latitude</th>
          <th>longitude</th>
          <th>isMobile</th>
          <th>tsStart</th>
          <th>tsEnd</th>
          <th>projectID</th>
          <th>elevation</th>
        </tr>
      ⟦#deployments⟧
        <tr class="recv_deps_table_row">
          <td>⟦deployID⟧</td>
          <td>⟦name⟧</td>
          <td>⟦fixtureType⟧</td>
          <td>⟦latitude⟧</td>
          <td>⟦longitude⟧</td>
          <td>⟦isMobile⟧</td>
          <td>⟦fmt_tsStart⟧</td>
          <td>⟦fmt_tsEnd⟧</td>
          <td>⟦projectID⟧</td>
          <td>⟦elevation⟧</td>
        </tr>
      ⟦/deployments⟧
      ⟦^deployments⟧
      (no deployments registered with motus.org for this receiver)
      ⟦/deployments⟧
      </table>
      <div class="recv_file_days">Activity by Day</div>
      <ul>
        <li>SG: file count</li>
        <li>Lotek: any detections?</li>
        <li>red background: db/repo file count mismatch.</li>
      </ul>
      ⟦#fileCounts⟧
          <span class="recv_file_day_count ⟦fileCountStatus⟧" serno="⟦serno⟧" day="⟦day⟧">⟦fmt_fileCount⟧</span>
      ⟦/fileCounts⟧
      ⟦^fileCounts⟧
      (no files on server for this receiver)
      ⟦/fileCounts⟧
      </table>
    </script>
    <script id="tpl_recv_files" type="text/html">
      {{! template to render details of files from a receiver}}
      {{=⟦ ⟧=}}
      <table class="recv_files_table_table">
        <tr class="recv_files_table_heading">
          <th>fileID</th>
          <th>bootnum</th>
          <th>monoBN</th>
          <th>name</th>
          <th>contentSize</th>
          <th>fileSize</th>
          <th>jobID</th>
        </tr>
      ⟦#fileDetails⟧
        <tr class="recv_files_table_row">
          <td>⟦fileID⟧</td>
          <td>⟦bootnum⟧</td>
          <td>⟦monoBN⟧</td>
          <td>⟦name⟧</td>
          <td class="byte_count">⟦contentSize⟧</td>
          <td class="byte_count">⟦fileSize⟧</td>
          <td ⟦&jobIDattr⟧>⟦jobID⟧</td>
        </tr>
      ⟦/fileDetails⟧
      ⟦^fileDetails⟧
      (no files on server for this receiver and day)
      ⟦/fileDetails⟧
      </table>
    </script>
    <script id="tpl_job_dump" type="text/html">
      {{! template to render a job dump query}}
      {{=⟦ ⟧=}}
      Job ⟦jobID⟧ had an error and a stack dump is available to help with debugging.
      <div>
        You can:
        <ul>
          <li><a href="⟦URL⟧" class="url">click here</a> to download the stack dump (.rds file; ⟦fmt_size⟧)</li>
          <li><b>or</b> load the file directly into R/rstudio running on this server, using this code:
<pre>
   x = readRDS("⟦path⟧")
</pre>
          </li>
          <li><b>or</b> hit <em>Esc</em> to close this window.</li>
        </ul>
    </script>
  </body>
</html>
