<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<!--


    This file generates the status download page at
    https://sgdata.motus.org/status2  It requires authentication via
    apache's mod_auth_tkt.  The authentication cookie is generated by
    the script login.php

    Data fetching uses jquery $.query() calls to the status server
    API.  Data rendering uses the jquery mustache plugin, with white
    mathematical square brackets as tag delimiters.  We've modifed
    mustache.js to allow tagging javascript objects with a logical
    attribute called "__transpose__".  If this is truthy, the object
    is treated as a list of arrays, whose elements are recycled to the
    length of the longest array.  This is an alternative layout to the
    usual array of objects, wherein each object has the same named
    items, and is compatible with the JSON returned by the status API.

    Replies from the status API are normally bz2-compressed
    JSON-encoded objects,but if the request includes an
    `Accept-Encoding` header containing the word 'gzip', they are
    gzip-compressed.  This page uses that feature, because
    browser-side javascript doesn't seem to support bz2-compression.

    API documentation is here:

    https://github.com/jbrzusto/motusServer/blob/new_server/inst/doc/status_api.md

  -->
    <title>Status of Motus Processing Version 2 (using API back-end)</title>
    <script language="javascript" type="text/javascript"
            src="/javascript/jquery/jquery.min.js"></script>
    <script language="javascript" type="text/javascript"
            src="/download/status2.js"></script>
    <script language="javascript" type="text/javascript"
            src="/download/jquery.mustache.min.js"></script>
    <script language="javascript" type="text/javascript"
            src="/download/mustache.min.js"></script>
    <script language="javascript" type="text/javascript"
            src="/download/status2.js"></script>
    <script language="javascript"  type="text/javascript"
            src="/download/jquery-ui-1.12.1/jquery-ui.min.js">script</script>
    <link rel="stylesheet" href="/download/jquery-ui-1.12.1/jquery-ui.min.css">
    <link rel="stylesheet" href="/download/status2.css">
    <script language="javascript" type="text/javascript">
      // once the page and scripts have loaded, launch the business logic to populate it.
        $(initStatus2Page);
    </script>
  </head>
  <body>
      <span class="jobs_heading">Status of your motus data-processing jobs</span>
      <div class="jobs_navigation">
        <span class="navigate" target="top"></span>
        <span class="navigate" target="up"></span>
        <span class="navigate" target="down"></span>
        <span class="navigate" target="bottom"></span>
        <label for="find_job_selector">Listing shows</label>
        <select id="find_job_selector">
          <option value="all" selected>all jobs</option>
          <option value="id">only job with ID = </option>
          <option value="idnear">only jobs with ID >= </option>
          <option value="motusUserID">only jobs for motus user ID = </option>
          <option value="log">only jobs with log matching</option>
        </select>
        <input type="text" id="find_job_key" value="">
        <span id="find_job_button"></span>
      </div>
    <div class="job_list">
    </div>
    <div class="job_details">
    </div>
    <div class="job_error">
    </div>
    <div class="job_no_results">
    </div>

    <script id="tpl_job_list" type="text/html">
      {{! template to render the table of jobs }}
      {{=⟦ ⟧=}}
      <table class="jobs_table">
        <tr class="jobs_table_heading">
          <th><span class="sort_heading" sort_field="id">Job ID</span></th>
          <th><span class="sort_heading" sort_field="motusUserID">Motus User ID</span></th>
          <th><span class="sort_heading" sort_field="type">Type</span></th>
          <th><span class="sort_heading" sort_field="ctime">Created</span></th>
          <th><span class="sort_heading" sort_field="mtime">Last Activity</span></th>
          <th><span class="sort_heading" sort_field="sjDone">Status</span></th>
          <th>Parameters</th>
        </tr>
        ⟦#jobs⟧
        <tr class="jobs_table_row" job_id="⟦id⟧" id="jobs_table_row⟦id⟧">
          <td class="job_id">⟦id⟧</td>
          <td class="job_motus_user_id">⟦motusUserID⟧
          <td class="job_type">⟦type⟧</td>
          <td class="timestamp">⟦fmt_ctime⟧</td>
          <td class="timestamp">⟦fmt_mtime⟧</td>
          <td>⟦&fmt_done⟧</td>
          <td class="job_params">⟦params⟧</td>
        </tr>
        ⟦/jobs⟧
      </table>
    </script>

    <script id="tpl_job_details" type="text/html">
      {{! template to render the details of a job}}
      {{=⟦ ⟧=}}
      <span class="job_product_heading">Products:</span>
      <div id="job_product_list">
        <ul>
          ⟦#products⟧
          <li class="job_product_list_item"><a href="⟦link⟧" target="_blank">⟦name⟧</a></li>
          ⟦/products⟧
          ⟦^products⟧
          (none)
          ⟦/products⟧
        </ul>
      </div>
      <span class="subjobs_heading">Sub Jobs:</span>
      <table class="subjobs_table">
        <tr class="subjobs_table_heading">
          <th>Job ID</th>
          <th>Type</th>
          <th>Created</th>
          <th>Status</th>
          <th>Parameters</th>
        </tr>
        ⟦#details⟧
        <tr class="subjob_table_row" job_id="⟦id⟧">
          <td class="job_id">⟦id⟧</td>
          <td class="job_type">⟦type⟧</td>
          <td class="timestamp">⟦fmt_ctime⟧</td>
          <td>⟦&fmt_done⟧</td>
          <td class="job_params">⟦params⟧</td>
        </tr>
        ⟦/details⟧
      </table>
      <div>
        <span class="log_heading">Log:</span>
        <div class="job_log">
      ⟦! the next item is not indented, to support `preformatted` styling⟧
⟦log⟧
        </div>
      </div>
    </script>
    <script id="tpl_job_error" type="text/html">
      {{! template to render an error message}}
      {{=⟦ ⟧=}}
      <div>
        <span class="copy_error_message">Copy Error to Clipboard</span>
      </div>
      When trying to fetch job information, this error was received:
      ⟦! the next `div` holds what gets copied to the clipboard⟧
      <div class="job_error_contents">
        <div class="job_error_message">
          ⟦error⟧
        </div>
        The api entry called was:
        <div class="job_error_api">
          ⟦api⟧
        </div>
        with these parameters:
        <div class="job_error_json">
      ⟦! the next item is not indented, to support `preformatted` styling⟧
⟦json⟧
        </div>
        and this browser state:
        <div class="job_error_state">
      ⟦! the next item is not indented, to support `preformatted` styling⟧
⟦state⟧
        </div>
      </div>
    </script>
    <script id="tpl_job_no_results" type="text/html">
      {{! template to render a message indicating no results}}
      {{=⟦ ⟧=}}
      <div class="job_no_results_message">
        There are no (more?) jobs matching the search criteria.
        Hit ESC to close this window.
      </div>
    </script>
  </body>
</html>
