<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<!--


    This file generates the status download page at
    https://sgdata.motus.org/status2  It requires authentication via
    apache's mod_auth_tkt.  The authentication cookie is generated by
    the script login.php

    Data fetching uses jquery $.query() calls to the status server
    API.  Data rendering uses the jquery mustache plugin, with white
    mathematical square brackets as tag delimiters.  We've modifed
    mustache.js to allow tagging javascript objects with a logical
    attribute called "__transpose__".  If this is truthy, the object is
    treated as a list of arrays, whose elements are recycled to the
    length of the longest array.  This is an alternative layout to the
    usual array of objects, wherein each object has the same named
    items, and is directly compatible with the JSON returned by the
    status API.

    Replies from the status API are normally bz2-compressed
    JSON-encoded objects,but if the request includes an
    `Accept-Encoding` header containing the word 'gzip', they are
    gzip-compressed.  This page uses that feature, because
    browser-side javascript doesn't seem to support bz2-compression.

    API documentation is here:

    https://github.com/jbrzusto/motusServer/blob/new_server/inst/doc/status_api.md

  -->
    <title>Status of Motus Processing Version 2 (using API back-end)</title>
    <script language="javascript" type="text/javascript"
            src="/javascript/jquery/jquery.min.js"></script>
    <script language="javascript" type="text/javascript"
            src="/download/status2.js"></script>
    <script language="javascript" type="text/javascript"
            src="/download/jquery.mustache.min.js"></script>
    <script language="javascript" type="text/javascript"
            src="/download/mustache.min.js"></script>
    <script language="javascript" type="text/javascript"
            src="/download/status2.js"></script>
    <script language="javascript"  type="text/javascript"
            src="/download/jquery-ui-1.12.1.custom/jquery-ui.min.js">script</script>
    <link rel="stylesheet" href="/download/jquery-ui-1.12.1.custom/jquery-ui.min.css">
    <link rel="stylesheet" href="/download/status2.css">
    <script language="javascript" type="text/javascript">
      // once the page and scripts have loaded, launch the business logic to populate it.
        $(initStatus2Page);
    </script>
  </head>
  <body>
    <div class="job_list">
    </div>
    <div class="job_details">
    </div>

    <script id="tpl_job_list" type="text/html">
      {{! template to render the table of jobs }}
      {{=⟦ ⟧=}}
      <span class="jobs_heading">Status of your motus data-processing jobs</span>
      <table class="jobs_table">
        <tr class="jobs_table_heading">
          <th>Job ID</th>
          <th>Motus User ID</th>
          <th>Type</th>
          <th>Created</th>
          <th>Last Activity</th>
          <th>Status</th>
          <th>Parameters</th>
        </tr>
        ⟦#jobs⟧
        <tr class="jobs_table_row" job_id="⟦id⟧" id="jobs_table_row⟦id⟧">
          <td class="job_id">⟦id⟧</td>
          <td class="job_motus_user_id">⟦motusUserID⟧
          <td class="job_type">⟦type⟧</td>
          <td class="timestamp">⟦fmt_ctime⟧</td>
          <td class="timestamp">⟦fmt_mtime⟧</td>
          <td>⟦&fmt_done⟧</td>
          <td class="job_params">⟦params⟧</td>
        </tr>
        ⟦/jobs⟧
      </table>
    </script>

    <script id="tpl_job_details" type="text/html">
      {{! template to render the details of a job}}
      {{=⟦ ⟧=}}
      <span class="job_product_heading">Products:</span>
      <div id="job_product_list">
        <ul>
          ⟦#products⟧
          <li class="job_product_list_item"><a href="⟦link⟧" target="_blank">⟦name⟧</a></li>
          ⟦/products⟧
          ⟦^products⟧
          (none)
          ⟦/products⟧
        </ul>
      </div>
      <span class="subjobs_heading">Sub Jobs:</span>
      <table class="subjobs_table">
        <tr class="subjobs_table_heading">
          <th>Job ID</th>
          <th>Type</th>
          <th>Created</th>
          <th>Status</th>
          <th>Parameters</th>
        </tr>
        ⟦#details⟧
        <tr class="subjob_table_row" job_id="⟦id⟧">
          <td class="job_id">⟦id⟧</td>
          <td class="job_type">⟦type⟧</td>
          <td class="timestamp">⟦fmt_ctime⟧</td>
          <td>⟦&fmt_done⟧</td>
          <td class="job_params">⟦params⟧</td>
        </tr>
        ⟦/details⟧
      </table>
      <div>
        <span class="log_heading">Log:</span>
        <div class="job_log">
          ⟦log⟧
        </div>
      </div>
    </script>
  </body>
</html>
