# The motusServer status API #

This API provides access to information about the motus data processing
server, jobs, and errors.

## API summary ##

### Request ###
 - requests are sent by the HTTP POST method
 - the request has header `Content-Type: application/x-www-form-urlencoded`
 - the POST data has a single item called `json`
 - the fields of `json` are the parameters listed for each API entrypoint below.
 - most requests require an `authToken` value, which can be obtained by a call
   to `authenticate_user`; alternatively, it can be the value (*not* URL-encoded) of a cookie
   named `auth_tkt` which is generated by the server's [main login page](https://sgdata.motus.org/login.php)
   according to the Apache mod-auth-tkt module.  Code for generating the cookie can
   be seen in [R](https://github.com/jbrzusto/motusServer/blob/new_server/R/validate_request.R)
   or in [PHP](https://github.com/jbrzusto/motusServer/blob/new_server/inst/scripts/www/login.php)

### Reply ###
 - is a json object: header `Content-Type = application/json`
 - is bzip2-compressed: header `Content-Encoding = bzip2`
 - most return values are lists of vectors of
   equal length, which is the natural JSON encoding of an R data.frame
 - errors are indicated by including a field called `error` in the reply; other
   fields might be present, giving additional information.  If no field `error`
   is present, the request succeeded.
 - requests return a (fixed) maximum number of rows.  If a reply has
   fewer than the maximum number of rows, there are no further data
   for the given query; i.e. the next `paging` call to the same API
   would return 0 rows.  The maximum number of rows can be obtained by
   calling `api_info`

Examples are given for each call using the command-line
client [curl](https://curl.haxx.se/download.html) with quoting
appropriate for the Bash shell.  These examples return the raw
bzip2-compressed data. To view the response, redirect the output of
curl into a file and use [7zip](http://7-zip.org) to decompress it
(for example), or add ` | bunzip2 -cd ` to the end of the command in
Bash.

The server is at [https://sgdata.motus.org](https://sgdata.motus.org) and the URL prefix is "/status".

## API calls ##

### api info ###

   api_info (authToken)

   - return a list with these items:

      - maxRows: integer, maximum number of rows returned by a query

      e.g.
      curl https://sgdata.motus.org/status/api_info


### authenticate user ###

   authenticate_user (user, password)

      - user: username
      - password: password (in cleartext)

      e.g.
      curl --data-urlencode json='{"user":"someone","password":"bigsecret"}' https://sgdata.motus.org/status/authenticate_user

   - returns a list with these items:
      - authToken: character string; 264 random bits, base64-encoded
      - expiry: numeric timestamp of expiry for token
      - userID: integer motus ID for user
      - projects: integer vector of project #s user is allowed to request tag detections for
      - receivers: character vector of serial #s of receivers user is allowed to request tag detections for

   or

   - a list with this item:
      - error: "authentication with motus failed"

### Notes ###

1. The `authToken` returned by this API must be included in most other API calls.

2. Authorization is by project: if a user has permission for a
project, then that user can see:

   - status of all jobs submitted for that project

If an API call does not find any information for which the user is
authorized, it will return a json object of the usual structure,
except that column arrays will have length zero.  This represents an R
data.frame with the correct column names but zero rows.

The API doesn't currently provide a way to tell whether there are additional data
which would be returned for a given call if the user had authorization for more
projects.


### list_jobs ###

   list_jobs (projectID, userID, sortBy, lastKey, includeUnknownProjects, full, countOnly, authToken)

       - projectID: integer motus project ID
       - userID: integer motus user ID
       - sortBy: character array; the sort key, zero or more of these string constants, each of which
         can be optionally followed by the string constant 'desc' for descending order
          - "ctime", "ctime desc": job creation time
          - "mtime", "mtime desc": last job activity time
          - "id", "id desc": job ID number
          - "type", "type desc": job type
          - "motusProjectID", "motusProjectID desc": motus project ID
          - "motusUserID", "motusUserID desc": motus user ID
         if `sortBy` is not specified, it is set to `["mtime desc"]`
       - lastKey: optional; vector giving "last" obtained value of each field specified in `sortBy`, in the same order; for paging
       - includeUnknownProjects: include jobs with no associated motus project; typically for
         jobs initiated by staff or otherwise not having a useful concept of project
       - full: if `true`, then full details for the job (typically its parameters, log, summary, and list of
         product files) are returned in a JSON-formatted column called `data`
       - countOnly: if true, return only a count of jobs for the given projectID and/or userID

      e.g.
      curl --data-urlencode json='{"userno":232,"authToken":"XXX"}' https://sgdata.motus.org/status/list_jobs

   - return a list of jobs for the given project and/or user.  If neither is specified, all jobs to which the
     user has permission are returned.  Otherwise, only jobs for the specified user and/or projectID are
     returned.

   - if `countOnly` is `false`, items in the return value are arrays:
      - `id`: job ids
      - `pid`: parent job ids
      - `stump`: top-level job ids
      - `ctime`: creation times (unix timestamp; seconds since 1 Jan 1970 GMT)
      - `mtime`: modification time (unix timestamp; seconds since 1 Jan 1970 GMT)
      - `type`: type of job; e.g. "ltFindtags"
      - `done`: 0 if not yet run; +1 if successful; < 0 if error
      - `queue`: number of queue job is in; 0 means waiting
      - `path`: file system path to job folder, if any
      - `motusUserID`: motus user ID of person who submitted job
      - `motusProjectID`: project ID for results of job
      - `data`: (if `full` was `true` in the request) sub-object representing job parameters, log, summary, products
